<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Golf Tracker – GPS + Vision + Voice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { font-size: 1.4rem; }
    label { display: block; margin-top: 0.5rem; }
    select, input, button { font-size: 1rem; padding: 0.4rem; margin-top: 0.2rem; }
    .row { margin-top: 0.8rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.3rem; font-size: 0.9rem; }
    th { background: #f3f3f3; }
    #gpsStatus, #visionStatus, #voiceStatus, #courseStatus {
      margin-top: 0.3rem; font-size: 0.9rem; color: #555;
    }
    #map { width: 100%; height: 200px; margin-top: 1rem; border: 1px solid #ccc; }

    #visionContainer { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
    #video { width: 100%; max-height: 200px; background: #000; }
  </style>
</head>
<body>
  <h1>Golf Tracker – GPS + Vision + Voice</h1>

  <!-- GPS + Course / Hole + Map -->
  <div class="row">
    <button id="gpsBtn">Start GPS Tracking</button>
    <div id="gpsStatus">GPS not started</div>
    <div id="courseStatus">Course: unknown | Hole: unknown | Yards to pin: -</div>
  </div>
  <div id="map"></div>

  <!-- Vision AI (camera) -->
  <div id="visionContainer">
    <strong>Vision club detection (camera)</strong>
    <video id="video" autoplay playsinline></video>
    <div id="visionStatus">Camera not started</div>
    <button id="visionBtn">Start Vision Detection</button>
  </div>

  <!-- Club selection + Voice -->
  <div class="row">
    <label>
      Club:
      <select id="club">
        <!-- Drivers -->
        <option>Driver</option>
        <!-- Woods -->
        <option>3W</option>
        <option>5W</option>
        <option>7W</option>
        <!-- Hybrids -->
        <option>2H</option>
        <option>3H</option>
        <option>4H</option>
        <option>5H</option>
        <!-- Irons -->
        <option>1I</option>
        <option>2I</option>
        <option>3I</option>
        <option>4I</option>
        <option>5I</option>
        <option>6I</option>
        <option>7I</option>
        <option>8I</option>
        <option>9I</option>
        <!-- Wedges -->
        <option>PW</option>  <!-- Pitching wedge -->
        <option>AW</option>  <!-- Approach wedge -->
        <option>GW</option>  <!-- Gap wedge -->
        <option>SW</option>  <!-- Sand wedge -->
        <option>LW</option>  <!-- Lob wedge -->
        <!-- Putter -->
        <option>Putter</option>
      </select>
    </label>
  </div>

  <div class="row">
    <button id="voiceBtn">Use Voice for Club</button>
    <div id="voiceStatus">Voice not listening</div>
  </div>

  <!-- Logging -->
  <div class="row">
    <button id="logStrokeBtn">Log Stroke</button>
    <button id="clearBtn" style="margin-left:0.5rem;">Clear All</button>
  </div>

  <div class="row">
    <strong>Total strokes: <span id="strokeCount">0</span></strong>
  </div>

  <table id="logTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Course</th>
        <th>Hole</th>
        <th>Club</th>
        <th>Yards to Pin</th>
        <th>Shot Distance</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const STORAGE_KEY = 'golfTrackerLog';
  const MAP_ZOOM = 17;

  let gps = { lat: null, lng: null };
  let detectedCourse = null;
  let detectedHole = null;
  let yardsToPin = null;
  let lastShotLocation = null;

  let visionRunning = false;
  let videoStream = null;

  // ------------ Haversine distance helper ------------

  function distanceInYards(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c) * 1.09361;
  }

  // ------------ Course API integration (stub) ------------
  /**
   * This is where you call a real API.
   * Expected shape (example):
   * {
   *   courseName: "Some GC",
   *   holeNumber: 7,
   *   pin: { lat: 40.123, lng: -75.456 }
   * }
   */
  async function fetchCourseInfo(lat, lng) {
    // Replace this URL with your real API endpoint.
    const url = `https://example.com/api/golf-courses?lat=${lat}&lng=${lng}`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      // Adjust these property names to match your API.
      const courseName = data.courseName;
      const holeNumber = data.holeNumber;
      const pin = data.pin; // { lat, lng }

      if (courseName && holeNumber && pin && pin.lat && pin.lng) {
        detectedCourse = courseName;
        detectedHole = holeNumber;
        yardsToPin = Math.round(distanceInYards(lat, lng, pin.lat, pin.lng));
        updateCourseStatus();
      } else {
        // Fallback: unknown course/hole
        detectedCourse = null;
        detectedHole = null;
        yardsToPin = null;
        updateCourseStatus("API returned incomplete data");
      }
    } catch (err) {
      // For now, just log error; keep previous values.
      console.error("Course API error:", err);
      updateCourseStatus("Course API error or unavailable");
    }
  }

  function updateCourseStatus(extraMsg) {
    const statusEl = document.getElementById('courseStatus');
    const base = `Course: ${detectedCourse || "unknown"} | ` +
                 `Hole: ${detectedHole || "unknown"} | ` +
                 `Yards to pin: ${yardsToPin != null ? yardsToPin : "-"}`;
    statusEl.textContent = extraMsg ? base + " (" + extraMsg + ")" : base;
  }

  // ------------ Map ------------

  function updateMap() {
    if (!gps.lat) return;
    const url = `https://maps.google.com/maps?q=${gps.lat},${gps.lng}&z=${MAP_ZOOM}&output=embed`;
    document.getElementById("map").innerHTML =
      `<iframe width="100%" height="200" frameborder="0" src="${url}"></iframe>`;
  }

  // ------------ GPS tracking ------------

  document.getElementById('gpsBtn').addEventListener('click', () => {
    if (!navigator.geolocation) {
      document.getElementById('gpsStatus').textContent = "GPS not supported in this browser.";
      return;
    }

    navigator.geolocation.watchPosition(async pos => {
      gps.lat = pos.coords.latitude;
      gps.lng = pos.coords.longitude;

      document.getElementById('gpsStatus').textContent =
        `GPS: ${gps.lat.toFixed(5)}, ${gps.lng.toFixed(5)}`;

      updateMap();

      // Call your course API whenever GPS updates (you can debounce this if needed).
      await fetchCourseInfo(gps.lat, gps.lng);

    }, err => {
      document.getElementById('gpsStatus').textContent = "GPS error: " + err.message;
    });
  });

  // ------------ Local storage / log rendering ------------

  function loadLog() {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  }

  function saveLog(log) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(log));
  }

  function renderLog() {
    const log = loadLog();
    const tbody = document.querySelector('#logTable tbody');
    const strokeCount = document.getElementById('strokeCount');
    tbody.innerHTML = '';

    log.forEach((entry, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${entry.course || "-"}</td>
        <td>${entry.hole || "-"}</td>
        <td>${entry.club}</td>
        <td>${entry.yardsToPin ?? "-"}</td>
        <td>${entry.shotDistance ?? "-"}</td>
        <td>${entry.time}</td>
      `;
      tbody.appendChild(tr);
    });

    strokeCount.textContent = log.length;
  }

  // ------------ Stroke logging ------------

  document.getElementById('logStrokeBtn').addEventListener('click', () => {
    const club = document.getElementById('club').value;
    const now = new Date().toLocaleTimeString();

    let shotDistance = null;
    if (lastShotLocation && gps.lat) {
      shotDistance = Math.round(
        distanceInYards(lastShotLocation.lat, lastShotLocation.lng, gps.lat, gps.lng)
      );
    }

    if (gps.lat) {
      lastShotLocation = { lat: gps.lat, lng: gps.lng };
    }

    const log = loadLog();
    log.push({
      course: detectedCourse,
      hole: detectedHole,
      club,
      yardsToPin,
      shotDistance,
      time: now
    });

    saveLog(log);
    renderLog();
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if (confirm('Clear all logged strokes?')) {
      localStorage.removeItem(STORAGE_KEY);
      renderLog();
    }
  });

  // ------------ Vision AI (stub) ------------

  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      document.getElementById('visionStatus').textContent = "Camera not supported in this browser.";
      return;
    }
    const video = document.getElementById('video');
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = videoStream;
      document.getElementById('visionStatus').textContent =
        "Camera started. Point it at the club head.";
    } catch (err) {
      document.getElementById('visionStatus').textContent = "Camera error: " + err.message;
    }
  }

  // Hook where a real model would go.
  async function detectClubFromFrame(video) {
    // Placeholder: replace with real model inference.
    const clubs = ["Driver","7I","PW","Putter","5I","3W","SW","LW","3H"];
    if (Math.random() < 0.03) {
      return clubs[Math.floor(Math.random() * clubs.length)];
    }
    return null;
  }

  async function visionLoop() {
    const video = document.getElementById('video');
    const statusEl = document.getElementById('visionStatus');

    if (!visionRunning) return;
    if (!videoStream) {
      statusEl.textContent = "Camera not active.";
      return;
    }

    const detected = await detectClubFromFrame(video);
    if (detected) {
      const clubSelect = document.getElementById('club');
      const options = Array.from(clubSelect.options);
      const match = options.find(o => o.value.toLowerCase() === detected.toLowerCase());
      if (match) {
        clubSelect.value = match.value;
        statusEl.textContent = "Vision detected club: " + match.value;
      } else {
        statusEl.textContent = "Vision detected unknown club: " + detected;
      }
    }

    requestAnimationFrame(visionLoop);
  }

  document.getElementById('visionBtn').addEventListener('click', async () => {
    if (!visionRunning) {
      await startCamera();
      visionRunning = true;
      document.getElementById('visionBtn').textContent = "Stop Vision Detection";
      document.getElementById('visionStatus').textContent =
        "Vision detection running (stub).";
      requestAnimationFrame(visionLoop);
    } else {
      visionRunning = false;
      document.getElementById('visionBtn').textContent = "Start Vision Detection";
      document.getElementById('visionStatus').textContent = "Vision detection stopped.";
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
    }
  });

  // ------------ Voice input (Web Speech API) ------------

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
  }

  function normalizeClubFromSpeech(text) {
    const t = text.toLowerCase();

    // Drivers / woods
    if (t.includes("driver")) return "Driver";
    if (t.includes("3 wood") || t.includes("three wood")) return "3W";
    if (t.includes("5 wood") || t.includes("five wood")) return "5W";
    if (t.includes("7 wood") || t.includes("seven wood")) return "7W";

    // Hybrids
    if (t.includes("2 hybrid") || t.includes("two hybrid")) return "2H";
    if (t.includes("3 hybrid") || t.includes("three hybrid")) return "3H";
    if (t.includes("4 hybrid") || t.includes("four hybrid")) return "4H";
    if (t.includes("5 hybrid") || t.includes("five hybrid")) return "5H";

    // Irons
    const ironMatch = t.match(/(1|2|3|4|5|6|7|8|9)\s*iron/);
    if (ironMatch) return ironMatch[1] + "I";

    // Wedges
    if (t.includes("pitching wedge")) return "PW";
    if (t.includes("approach wedge")) return "AW";
    if (t.includes("gap wedge")) return "GW";
    if (t.includes("sand wedge")) return "SW";
    if (t.includes("lob wedge")) return "LW";

    // Putter
    if (t.includes("putter") || t.includes("putt")) return "Putter";

    return null;
  }

  document.getElementById('voiceBtn').addEventListener('click', () => {
    const statusEl = document.getElementById('voiceStatus');

    if (!recognition) {
      statusEl.textContent = "Voice recognition not supported in this browser.";
      return;
    }

    statusEl.textContent = "Listening... say your club (e.g., '7 iron', 'driver').";
    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      statusEl.textContent = "Heard: " + transcript;

      const club = normalizeClubFromSpeech(transcript);
      if (club) {
        const clubSelect = document.getElementById('club');
        clubSelect.value = club;
        statusEl.textContent = `Set club from voice: ${club}`;
      } else {
        statusEl.textContent += " (could not map to a club).";
      }
    };

    recognition.onerror = (event) => {
      statusEl.textContent = "Voice error: " + event.error;
    };

    recognition.onend = () => {
      if (statusEl.textContent.startsWith("Listening")) {
        statusEl.textContent = "Voice stopped (no input).";
      }
    };
  });

  // ------------ Init ------------

  renderLog();
  updateCourseStatus();
</script>
</body>
</html>

