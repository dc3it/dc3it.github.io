<!--
    Copyright 2022

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Story Builder</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.0.1/css/buttons.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/searchbuilder/1.3.0/css/searchBuilder.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/1.4.0/css/searchPanes.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.4/css/select.dataTables.min.css" />
    <!-- <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.2.3/css/fixedHeader.dataTables.min.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shepherd.js/9.0.0/css/shepherd.min.css"
        integrity="sha512-g7F1lXNWWNdbCy2Qk6XTRx5FJ9U1w1rOmFo3/cIJApqtPBBd4GYGxV/MLnM0CVtVyWqIwnpSVIWZACMEkKO/CQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        body,
        textarea {
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            opacity: 95%;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: top;
            background-size: contain;
            /* background-size: cover; */
        }

        /* eForm */
        #ctl00_MainContent_ctl00_btnSave,
        #ctl00_MainContent_ctl01_btnSaveBottom {
            border: none;
            font-size: 1.60em;
            color: white;
            padding: 12px 16px;
            text-decoration: none;
            margin: 2px 2px;
            cursor: pointer;
        }

        /* eForm */
        #ctl00_MainContent_ctl00_spanRelatedDocuments,
        #ctl00_MainContent_ctl01_spanRelatedDocumentsBottom {
            font-size: .5em;
        }

        div {
            font-size: 16px;
        }

        label {
            font-weight: bold;
        }

        table,
        td,
        th {
            border: 1px solid black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        pre {
            white-space: pre-wrap;
            /* Since CSS 2.1 */
            white-space: -moz-pre-wrap;
            /* Mozilla, since 1999 */
            white-space: -pre-wrap;
            /* Opera 4-6 */
            white-space: -o-pre-wrap;
            /* Opera 7 */
            word-wrap: break-word;
            /* Internet Explorer 5.5+ */
        }

        /* https://alligator.io/html/dialog-element/ */
        dialog {
            background-color: #cfdff5;
            color: #000000;
            text-align: center;
            border: none;
            padding: 2rem;
            border-radius: 6px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1), 0 0 10px rgba(0, 0, 0, 0.25);
            max-width: 90vw;
        }

        dialog[open] {
            animation: appear .15s cubic-bezier(0, 1.8, 1, 1.8);
        }

        dialog::backdrop {
            background: linear-gradient(45deg, rgba(112, 117, 116, 0.5), rgba(85, 110, 156, 0.5));
        }

        dialog .actions {
            display: flex;
            justify-content: space-around;
        }

        @keyframes appear {
            from {
                opacity: 0;
                transform: translateX(-3rem);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .btn {
            background-color: rgba(85, 110, 156, 0.5);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            margin-top: 5px;
            margin-left: auto;
            margin-right: auto;
            width: 125px;
        }

        input[type=file]::file-selector-button {
            background-color: rgba(85, 110, 156, 0.5);
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            margin-top: 5px;
            margin-left: auto;
            margin-right: auto;
            width: 125px;
            /* border: 2px solid #4CAF50;
            padding: 1em 1em;
            border-radius: .2em;
            color: white;
            background-color: #4CAF50;
            transition: 1s;
            font-size: 16px; */
        }

        /* input[type=file]::file-selector-button:hover {
            background-color: #81ecec;
            border: 2px solid #00cec9;
        } */

        .toast {
            background-color: green;
            z-index: 10;
            height: 75px;
            float: right;
            margin: -35px;
        }

        .toast>.swal-text {
            color: #fff;
        }

        .actions {
            float: right;
        }

        #closeSettings,
        #closeEdit {
            border: none;
            background: transparent;
        }

        .shepWalk {
            background-color: rgb(209, 219, 238);
        }

        .shepherd-header {
            background-color: #b0c4de;
        }

        .row {
            display: grid;
            grid-template-columns: 50% 50%;
            padding: 10px;
            width: 60%;
        }

        .column {
            text-align: left;
        }

        .settingsHelp {
            width: 60%;
        }

        .header {
            padding: .1em .1em;
            /* border-radius: 1em; */
            /* background:#8ABF5A; */
            color: #0e0d0d;
        }
    </style>
</head>

<body>
    <!-- <img src="https://www.agile-scrum.be/wordpress/wp-content/uploads/2014/08/User-stories-Agile-Scrum-Belgium-Training.png"
        style="height: 150px; display: block; margin-left: auto; margin-right: auto; width: 20%;" /> -->
    <h1>User Story Creation Panel<button type="button" id="configSettingsHelp"
            style="background-color: transparent; border: 0; vertical-align: top">
            <i class="fas fa-question-circle"></i></button><button type="button" id="openSettings"
            style="background: transparent;border: 0; float: right; margin-top: -50x">⚙️</button></h1>

    <div style="background-color: #ffffff">
        <div class="header" id="myHeader"
            style="position: -webkit-sticky; position: sticky; top: 0; background-color: #ffffff; z-index: 1">
            <div>
                <!-- category-datalist provides drodown, autocomplete, and custom entry -->
                <label for="category">Category:</label>
                <input name="category" id="category">

                <!-- user type-datalist provides drodown, autocomplete, and custom entry -->
                <label for="user">As a [type of user]</label>
                <input name="user" id="user">

                <!-- action value -->
                <label for="action">I want to [an action]</label>
                <textarea id="action" style="margin: 0px; width: 250px; height: 50px;vertical-align: top;"></textarea>
                <!-- benefit value -->
                <label for="benefit">so that [a benefit/value]</label>
                <textarea id="benefit" style="margin: 0px; width: 250px; height: 50px;vertical-align: top;"></textarea>
            </div>
            <!-- process story -->
            <div style="margin: auto; width:60%; padding:.10em;">
                <button type="button" id="processStory" class="btn">Add
                </button>
                <button type="button" id="editStory" class="btn">Edit
                </button>
                <button type="button" id="deleteStory" class="btn">Delete
                </button>
                <button type="button" id="clearStory" class="btn">Clear
                </button>
                <button class="btn">
                    <label>
                        <input type="file" id="openFile" style="display: none;" />
                        <a style="font-weight:normal">Choose File</a>
                    </label>
                </button>
                <!-- <button type="button" id="openStory" class="btn">Open</button> -->
            </div>
            <!-- stores all rows -->
            <textarea id="changesJSON" rows="10"
                style="margin: 0px; width: 1050px; height: 100px; display:none"></textarea>
        </div>
        <!-- apply rows to table -->
        <div style="background-color: #ffffff">
            <div style="padding: 1em">
                <table id="myTable"></table>
            </div>
        </div>
    </div>
    <div style="text-align: center;">
        <span>Powered by</span>
        <a href="https://dc3it.github.io" target="_blank"><img src="https://dc3it.github.io/images/DC3ITFAVICON.png"
                height="45px" width="45px" style="vertical-align: middle" /></a>
    </div>
    <!-- settings modal -->
    <dialog class="my-modal">
        <div class="actions">
            <button type="button" id="closeSettings">❌</button>
        </div>
        <div style="text-align: left">
            <h3>⚙️ Settings</h3>
            <p>Use this modal form to update the datalist (pseudo dropdown) choices.</p>
            <p>Make sure to use the | (pipe) symbol to separate the values.</p>
            <p>When first starting the app CLM examples are provided.</p>
            <h3>Enter Categories</h3>
            <textarea id="dataListCategories" rows="10" style="margin: 0px; width: 550px; height: 100px"></textarea>
            <div>
                <button type="button" id="addDataListCategories" class="btn">Add
                    Categories</button>
            </div>
            <h3>Enter Users</h3>
            <textarea id="dataListUsers" rows="10" style="margin: 0px; width: 550px; height: 100px"></textarea>
            <div>
                <button type="button" id="addDataListUsers" class="btn">Add
                    Users</button>
            </div>
            <h3>Turn off Guide Me</h3>
            <p>To turn off this guide click <input type='checkbox' id='doNotShowTour'></p>
        </div>
    </dialog>
    <!-- edit row modal -->
    <dialog id="confirm-edit" class="my-modal">
        <div class="actions">
            <button type="button" id="closeEdit">❌</button>
        </div>
        <header class="dialog-header" id="editHeader">
            <h1>Edit Entry</h1>
        </header>
        <div class="row">
            <div class="column">
                <label for="txbCategory">Category: </label>
            </div>
            <div class="column">
                <input type="text" id="txbCategory" />
            </div>
        </div>
        <div class="row">
            <div class="column">

                <label for="txbUser">As a [type of user] </label>
            </div>
            <div class="column">
                <input type="text" id="txbUser" />
            </div>
        </div>
        <div class="row">
            <div class="column">
                <label for="txbAction">I want to [an action] </label>
            </div>
            <div class="column">
                <textarea id="txbAction"
                    style="margin: 0px; width: 250px; height: 50px;vertical-align: top;"></textarea>
            </div>
        </div>
        <div class="row">
            <div class="column">
                <label for="txbBenefit">so that [a benefit/value] </label>
            </div>
            <div class="column">
                <textarea id="txbBenefit"
                    style="margin: 0px; width: 250px; height: 50px;vertical-align: top;"></textarea>
            </div>
        </div>
        <div>
            <button type="button" id="btnSaveEdit" class="btn">Save Changes</button>
            <button type="button" id="btnCancelEdit" class="btn">Cancel</button>
        </div>
    </dialog>


    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <!-- datatables.net is based on jQuery and requires various bolt ons for additional functionality MIT License -->
    <script src="https://cdn.datatables.net/1.12.0/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.0.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/searchbuilder/1.3.0/js/dataTables.searchBuilder.min.js"></script>
    <script src="https://cdn.datatables.net/searchpanes/1.4.0/js/dataTables.searchPanes.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/fixedheader/3.2.3/js/dataTables.fixedHeader.min.js"></script> -->
    <!-- shepherd js is MIT licensed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shepherd.js/9.0.0/js/shepherd.min.js"
        integrity="sha512-PW9R1HcNuXvRsX9Ibbjzki4sp5pqAl6GLNhkNeAA1jRfVWGXg+i9eRN9VC4r/i/W7WaA8f1/ejqRTR7pgr+R+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- sweet alert is MIT licensed and a nice popup -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>

        // #region opensource MIT walkme - shepherdjs ***
        // Description: handles creating a walkme concept for new users
        // Created on: 2022.03.20
        // Modified on:
        //  2022.05.16 added steps for Edit Delete Choose file
        // ***
        const tour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                classes: 'shepWalk',
                scrollTo: { behavior: 'smooth', block: 'center' },
                useModalOverlay: true,
                when: {
                    show() {
                        const currentStepElement = tour.currentStep.el;
                        const header = currentStepElement.querySelector('.shepherd-header');
                        const progress = document.createElement('span');
                        progress.style['margin-right'] = '15px';
                        progress.style['font-size'] = '9px';
                        progress.innerText = `${tour.steps.indexOf(tour.currentStep) + 1}/${tour.steps.length}`;
                        header.insertBefore(progress, currentStepElement.querySelector('.shepherd-cancel-icon'));
                        const footer = currentStepElement.querySelector('.shepherd-footer');
                        const progressBar = document.createElement('progress');
                        progressBar.style['margin-right'] = '50px';
                        progressBar.style['margin-top'] = '10px';
                        progressBar.max = tour.steps.length;
                        progressBar.value = tour.steps.indexOf(tour.currentStep) + 1;
                        footer.insertBefore(progressBar, currentStepElement.querySelector('.shepherd-button'));
                    }
                }
            }
        });
        tour.addStep({
            title: 'Welcome!',
            text: `This tool helps to generate User Stories and Acceptance Criteria. It is MIT licensed.`,
            attachTo: {
                element: '#configSettingsHelp',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'creating'
        });
        tour.addStep({
            title: 'Dropdown / Autocomplete / Datalist Settings',
            text: `To modify the dropdown / autocomplete / picklist / datalist choices and this guided tour, click the gear ⚙️ ICON in the upper right.`,
            attachTo: {
                element: '#openSettings',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'settings'
        });
        tour.addStep({
            title: 'Add',
            text: `To add a User Story, select the category and user, fill in the action and benefit descriptions, and click Add. The category and user lists offer autocomplete, dropdown, and overwrite functionality. Please <b>NOTE</b> all stories are stored in the browser's local storage. This means you can close and reopen the app and the stories will persist. However, if you clear the local storage, then the stories will be removed. Please use the Copy, CSV, and/or Save to File buttons to save the stories to more persistent file based storage.`,
            attachTo: {
                element: '#processStory',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'addStories'
        });
        tour.addStep({
            title: 'Edit',
            text: `Click to select a row from the table and then click edit to open a modal form where the values from that row can be modified and changes saved.`,
            attachTo: {
                element: '#editStory',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'editStories'
        });
        tour.addStep({
            title: 'Delete',
            text: `Click to select a row from the table and then click delete to remove the row from the table and local storage.`,
            attachTo: {
                element: '#deleteStory',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'deleteStories'
        });
        tour.addStep({
            title: 'Clear',
            text: `Click clear to remove all stories from the table and local storage. Please <b>NOTE</b> use the Copy, CSV, and/or Save to File buttons to save the stories to more persistent file based storage.`,
            attachTo: {
                element: '#clearStory',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'clearStories'
        });
        tour.addStep({
            title: 'Choose File',
            text: `Click choose file to select a JSON file that was created by the Save to File button. The Save to File button saves all the rows to a JSON formatted file and allows for persistent data storage to a desired location.`,
            attachTo: {
                element: '#openFile',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'chooseStories'
        });
        tour.addStep({
            title: 'Filtering and Sorting',
            text: `Stories can be filtered based on the Search box, the Custom Search Builder button, and the Search Pane. Each column is sortable. Multi column sorting is not enabled.`,
            attachTo: {
                element: '.dtsb-add dtsb-button',
                on: 'bottom'
            },
            buttons: [
                {
                    action() {
                        return this.back();
                    },
                    classes: 'shepherd-button-secondary',
                    text: 'Back'
                },
                {
                    action() {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'filterStories'
        });

        // tour.start();
        // #endregion

        // #region event listeners ***
        // Description: handles button event clicks
        // Created on: 2022.01.27
        // Modified on:
        //      2022.05.18 refactor date into reusable function
        // ***
        document.querySelector("#configSettingsHelp").addEventListener("click", () => {
            swal({
                title: "Settings Help",
                text: "Use this tool to generate user stories and acceptance criteria. The information is saved in the browser's local storage. If you clear the cache and storage, then the entries will be deleted. Prior to clearing the browser cache, please use the Copy, CSV, and/or Save to File buttons to save the stories to more persistent file based storage. Brought 2 u by 1 who is a fry short of a happy meal 🍟 \n\n Copyright 2022\n\n Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.",
                className: "settingsHelp",
                icon: "info"
            });
        });
        document.querySelector("#addDataListCategories").addEventListener("click", () => {
            updateDataList("dataListCategories", "categoryDataList", "category");
            toastMsg("Category DataList values updated!");
        });
        document.querySelector("#addDataListUsers").addEventListener("click", () => {
            updateDataList("dataListUsers", "userDataList", "user");
            toastMsg("User DataList values updated!");
        });
        //add
        document.querySelector("#processStory").addEventListener("click", () => {
            main();
        });
        //clear all
        document.querySelector("#clearStory").addEventListener("click", () => {
            swal({
                title: "Clear ALL Stories",
                text: "Are you sure you want to clear all stories from local storage? Have you backed the stories up to an external file or copied them to a file?",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            }).then((willDelete) => {
                if (willDelete) {
                    //reset localstorage and the textarea
                    localStorage.setItem("UsrStry", "");
                    document.querySelector("#changesJSON").value = "";
                    swal("Stories have been cleared!", {
                        icon: "success"
                    });
                    $('#myTable').DataTable().clear();
                    $('#myTable').DataTable().destroy();
                    $('#myTable + tbody').empty();
                    location.reload();
                }
            });
        });
        //settings gear icon open
        document.querySelector("#openSettings").addEventListener("click", () => {
            document.querySelector(".my-modal").showModal();
        });
        //settings modal close
        document.querySelector('#closeSettings').addEventListener("click", () => {
            document.querySelector('.my-modal').close();
        });
        //delete
        document.querySelector('#deleteStory').addEventListener("click", () => {
            if ($('#myTable').DataTable().rows({ selected: true }).count() > 0) {
                if (localStorage.getItem("UsrStry")) {
                    swal({
                        title: "Delete Story",
                        text: "Are you sure you want to delete this story?",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    }).then((willDelete) => {
                        if (willDelete) {
                            deleteRow();
                            dt();
                        }
                    });
                } else {
                    swal("There are no rows to delete", {
                        icon: "warning"
                    });
                }
            } else {
                swal("Please select a row to delete", {
                    icon: "warning"
                });
            }
        });

        //edit
        document.querySelector('#editStory').addEventListener("click", () => {
            //check if datatable has rows
            if ($('#myTable').DataTable().rows({ selected: true }).count() > 0) {
                //get the selected row
                let dataRow = $('#myTable').DataTable().rows({ selected: true }).data();
                //populate modal with values for editing              
                document.querySelector("#txbCategory").value = dataRow[0][0];
                document.querySelector("#txbUser").value = dataRow[0][1];
                document.querySelector("#txbAction").value = dataRow[0][2];
                document.querySelector("#txbBenefit").value = dataRow[0][3];
                //show the form
                document.querySelector("#confirm-edit").showModal();
            } else {
                swal("Please select a row to edit", {
                    icon: "warning"
                });
            }
        });
        //edit modal close
        document.querySelector('#closeEdit').addEventListener("click", () => {
            document.querySelector('#confirm-edit').close();
        });
        //edit modal cancel
        document.querySelector("#btnCancelEdit").addEventListener("click", () => {
            document.querySelector("#confirm-edit").close();
        });
        //edit modal save
        document.querySelector("#btnSaveEdit").addEventListener("click", () => {
            //close the modal
            document.querySelector("#confirm-edit").close();
            deleteRow();
            buildRows("edit");
            addRows();
            dt();
            toastMsg("User Story values updated!");
        });
        //walk me
        document.querySelector("#doNotShowTour").addEventListener("click", () => {
            if (localStorage.getItem("doNotShowTour")) {
                if (document.querySelector('#doNotShowTour').checked == true) {
                    localStorage.setItem("doNotShowTour", "true");
                } else {
                    localStorage.setItem("doNotShowTour", "false");
                }
            } else {
                localStorage.setItem("doNotShowTour", "true");
            }
        });
        //process uploaded json file 
        const fileInput = document.querySelector("#openFile");
        fileInput.onchange = () => {
            const selectedFile = fileInput.files[0];
            const reader = new FileReader();
            let lines = "";
            reader.onload = function (progressEvent) {
                let lines = JSON.parse(reader.result); //parse the json into an object
                let formattedLine = "";
                //extract the body because that is all that is needed
                //need to loop through body object and process each entry as the formatting is removed 
                for (let i = 0; i < lines.body.length; i++) {
                    let category = lines.body[i][0];
                    let user = lines.body[i][1];
                    let action = lines.body[i][2];
                    let benefit = lines.body[i][3];
                    let story = lines.body[i][4].replace("As a ", "<b>As a </b>").replace("I want to", "<b>I want to</b>").replace("so that ", "<b>so that </b>").replace("Acceptance Criteria:", "<br/><br/><b>Acceptance Criteria:</b><br/>").replace("Given ", "<b>Given </b>").replace("When ", "<br/><b>When </b>").replace("Then ", "<br/><b>Then </b>");
                    let dateAdded = lines.body[i][5];
                    formattedLine += `[ "${category}", "${user}", "${action}", "${benefit}", "${story}", "${dateAdded}" ], `;
                }
                localStorage.setItem("UsrStry", formattedLine);
                document.querySelector("#changesJSON").value = formattedLine;
            }
            reader.readAsText(selectedFile);
            location.reload();
        }
        // reset Category dropdown
        document.querySelector("#category").addEventListener("click", () => {
            document.querySelector("#category").value = "";
        })
        // reset User dropdown
        document.querySelector("#user").addEventListener("click", () => {
            document.querySelector("#user").value = "";
        })
        // #endregion

        // #region helper functions ***
        // Description: resuable misc functions
        // Created on: 2022.05.18
        // Modified on: 
        // ***
        const todaysDate = () => {
            const d = new Date();
            return (d.toLocaleString());
        }
        // #endregion

        // #region main routine ***
        // Description: handles entry point to processing user stories
        // Created on: 2022.01.27
        // Modified on:
        // 2022.01.27 - added buildRows 
        // ***
        const main = () => {
            buildRows("add");
            addRows();
            dt();
            toastMsg("New User Story Added!");
            // swal("New Record Status", "The record is added. The information is saved in the browser's local storage. If you clear the cache and storage, then the entries will be deleted. Prior to clearing the browser cache, please remember to click the CSV or Copy button to retain the table data.", "info");
        };
        // #endregion

        // #region build table rows ***
        // Description: handles concatenating the rows together and storing in hidden textarea
        // Params: 
        //      addOrEdit: create Row from different form controls
        // Created on: 2022.01.27
        // Modified on: 
        //      2022.04.28 refactor to handle JSON
        //      2022.03.10 added date added column
        //      2022.05.18 refactor date into reusable function add parameter addOrEdit
        // ***            
        const buildRows = (addOrEdit) => {
            //create json from add form controls or edit form controls
            if (addOrEdit !== "edit") {
                document.querySelector("#changesJSON").value += `[ "${document.querySelector("#category").value}", "${document.querySelector("#user").value}", "${document.querySelector("#action").value}", "${document.querySelector("#benefit").value}", "<b>As a </b>${document.querySelector("#user").value}, <b>I want to</b> ${document.querySelector("#action").value} <b>so that </b>${document.querySelector("#benefit").value}<br/><br/><b>Acceptance Criteria:</b><br/><b>Given </b>${document.querySelector("#user").value}<br/><b>When </b>${document.querySelector("#action").value}<br/><b>Then </b>${document.querySelector("#benefit").value}<br/>", "${todaysDate()}" ], `;
            } else {
                document.querySelector("#changesJSON").value += `[ "${document.querySelector("#txbCategory").value}", "${document.querySelector("#txbUser").value}", "${document.querySelector("#txbAction").value}", "${document.querySelector("#txbBenefit").value}", "<b>As a </b>${document.querySelector("#txbUser").value}, <b>I want to</b> ${document.querySelector("#txbAction").value} <b>so that </b>${document.querySelector("#txbBenefit").value}<br/><br/><b>Acceptance Criteria:</b><br/><b>Given </b>${document.querySelector("#txbUser").value}<br/><b>When </b>${document.querySelector("#txbAction").value}<br/><b>Then </b>${document.querySelector("#txbBenefit").value}<br/>", "${todaysDate()}" ], `;
            }
        }
        // #endregion

        // #region add row ***
        // Description: handles inserting new row into DOM/table and overwriting local storage with all rows
        // Created on: 2022.01.27
        // Modified on:
        //      2022.04.28 refactor to support JSON approach
        // ***
        const addRows = () => {
            if (document.querySelector("#changesJSON").value.length > 0) {
                localStorage.setItem("UsrStry", document.querySelector("#changesJSON").value);
            }
        };
        // #endregion

        // #region delete row ***
        // Description: handles deleting a higlighted row
        // Created on: 2022.05.18
        // Modified on: 
        // ***
        const deleteRow = () => {
            //get the selected row
            let dataRow = $('#myTable').DataTable().rows({ selected: true }).data();
            let dtRow = "";
            //convert the object to a string
            dtRow = JSON.stringify(dataRow[0]);
            //clean up for comparing
            dtRow = dtRow.replace(/\"/g, "").replace("[", "").replace("]", "").replace(/ /g, "");
            //create an array to hold existing rows
            let newResults = localStorage.getItem("UsrStry").split("],");
            let updatedRows = "";
            //find matching row and remove
            for (let i = 0; i < newResults.length - 1; i++) {
                //clean up row to enable compare
                let cleanRow = newResults[i].replace("[", "").replace(/\"/g, "").replace(/ /g, "");
                //test to see if rows match if not retain value
                if (dtRow !== cleanRow) {
                    updatedRows += newResults[i] + "],";
                }
            }
            document.querySelector("#changesJSON").value = updatedRows;
            localStorage.setItem("UsrStry", updatedRows);
        }
        // #endregion

        // #region update datalist ***
        // Description: handles updating the datalist
        // Params: 
        //      elemValuesID: values for DL
        //      dlID: new DL ID
        //      inputID: existing input ID
        // Created on: 2022.03.18
        // Modified on:
        // ***
        const updateDataList = (elemValuesID, dlID, inputID) => {
            //remove existing dataList - don't want dupes
            if (document.querySelector(`#${dlID}`)) {
                document.querySelector(`#${dlID}`).remove();
            }
            //declare array
            let newList = [];
            //break up the list into array to loop through and create dataList
            newList = document.querySelector(`#${elemValuesID}`).value.split("|");
            let newDataList = document.createElement('datalist');
            newDataList.id = `${dlID}`;
            document.body.appendChild(newDataList);
            for (let i = 0; i < newList.length; i++) {
                var newDataListOption = document.createElement("option");
                newDataListOption.value = newList[i];
                newDataList.appendChild(newDataListOption);
            }
            document.querySelector(`#${inputID}`).setAttribute('list', `${dlID}`);
            localStorage.setItem(dlID, document.querySelector(`#${elemValuesID}`).value);
        };
        // #endregion

        // #region toast message ***
        // Description: handles formatting toast message with sweetalert
        // Created on: 2022.03.19
        // Modified on:
        // ***
        const toastMsg = (msg) => {
            swal(msg, {
                timer: 1000,
                buttons: false,
                className: "toast"
            });
        };
        // #endregion

        // #region destroy datatable and regen ***
        // Description: handles clearing datatable from DOM and recreate when adding row otherwise errors will arise
        // Created on: 2022.01.27
        // Modified on:
        //      2022.01.27 added more settings for search pane, search builder, state save
        //      2022.05.11 added check for datatable row existence
        // ***
        const dt = () => {
            //test to see if the datatable has any rows
            if (document.querySelector('#myTable tbody')) {
                $('#myTable').DataTable().clear();
                $('#myTable').DataTable().destroy();
                $('#myTable + tbody').empty();
                addRows();
            }
            //get the data
            let json = localStorage.getItem("UsrStry");
            json = json.substring(0, json.lastIndexOf(","));
            let jsonData = `[ ${json} ] `;

            if (jsonData.indexOf(",") > 0) {
                jsonData = JSON.parse(jsonData);
                $('#myTable').DataTable({
                    searchPanes: {
                        layout: 'columns-2'
                    },
                    dom: 'PQlBfrtip',
                    buttons: [
                        'copy', 'csv',
                        {
                            text: 'Save to File',
                            action: function (e, dt, button, config) {
                                var data = dt.buttons.exportData();

                                $.fn.dataTable.fileSave(
                                    new Blob([JSON.stringify(data)]),
                                    'UserStories.json'
                                );
                            }
                        }
                    ],
                    stateSave: true,
                    select: true,
                    data: jsonData,
                    columns: [
                        { title: "Category" },
                        { title: "User" },
                        { title: "Action" },
                        { title: "Benefit" },
                        { title: "Story and AC" },
                        { title: "Date Added" }
                    ],
                    columnDefs: [
                        {
                            searchPanes: {
                                show: true
                            },
                            targets: [0, 1]
                        }
                    ],
                    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]
                }).draw();
            }
        };
        // #endregion

        // #region page ready ***
        // Description: handles pure JS document.ready event when page first loads/painted
        // Created on: 2022.01.27
        // Modified on:
        //      2022.05.03 added show tour logic
        // ***            
        window.addEventListener('DOMContentLoaded', (event) => {
            if (localStorage.getItem("UsrStry")) {
                //if localstorage has rows, then overwrite hidden textarea to build table
                document.querySelector("#changesJSON").value = localStorage.getItem("UsrStry");
            }
            //check for values to use to load the category datalist/dropdown
            if (localStorage.getItem("categoryDataList")) {
                document.querySelector("#dataListCategories").value = localStorage.getItem("categoryDataList");
                updateDataList("dataListCategories", "categoryDataList", "category");
                //reuse datalist for edit form
                document.querySelector("#txbCategory").setAttribute('list', "categoryDataList");
            } else {
                document.querySelector("#dataListCategories").value = "CLM Action Menu|CLM Admin Setting|CLM Attribute|CLM AutoNumber|CLM Branding|CLM CSV|CLM Dashboard|CLM eForm|CLM Group|CLM Task Group|CLM Workflow|CLM Intake Form|CLM Integration|CLM Merge Template|CLM Persona|CLM Report|CLM Schedule|CLM Smart Rule|eSignature Admin Setting|eSignature Agreement Rule|eSignature Branding|eSignature Custom Field|eSignature Integration|eSignature PowerForm|eSignature Report|eSignature Template";
                updateDataList("dataListCategories", "categoryDataList", "category");
                //reuse datalist for edit form
                document.querySelector("#txbCategory").setAttribute('list', "categoryDataList");
            }
            //check for values to use to load the user datalist/dropdown
            if (localStorage.getItem("userDataList")) {
                document.querySelector("#dataListUsers").value = localStorage.getItem("userDataList");
                updateDataList("dataListUsers", "userDataList", "user");
                //reuse datalist for edit form
                document.querySelector("#txbUser").setAttribute('list', "userDataList");
            } else {
                document.querySelector("#dataListUsers").value = "CLM User|CLM Admin|CLM Viewer|eSignature User|eSignature Admin|eSignature Viewer";
                updateDataList("dataListUsers", "userDataList", "user");
                //reuse datalist for edit form
                document.querySelector("#txbUser").setAttribute('list', "userDataList");
            }
            //tour settings
            if (localStorage.getItem("doNotShowTour") == "true") {
                document.querySelector("#doNotShowTour").checked = true;
            } else {
                document.querySelector("#doNotShowTour").checked = false;
                tour.start();
            }
            // need to check if json data present
            if (localStorage.getItem("UsrStry")) {
                //pull in rows (if any) and gen table
                addRows();
                dt();
            }
        });
        // #endregion
    </script>
</body>

</html>
